<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Project 2</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <link rel="stylesheet" type="text/css" href="all.css">
  <link href="https://fonts.googleapis.com/css?family=Aldrich|Audiowide|Fugaz+One|Gugi|Racing+Sans+One" rel="stylesheet">
</head>
<body>
<div id="header">
  <div id="title"><span>The Age of Residents Around a Restaraunt Doesn't Have Much Effect on its Rating</span></div><br/>
  <div id="leftP"><span>Anthony Verghese (akv26), Sam Ringel (sjr254), Isaiah Wilson (ijw23)</span></div>
  <div id="rightP"><span>INFO 3300</span></div>
</div>
<svg width="800" height="500" id="ageYelpPlot">
<line id="myLine" x1="395" y1="10" x2="395" y2="455" stroke="#d32323" stroke-width="3"  />
<foreignobject class="node" x="0" y="400" width="800" height="100">
<div id="divForSlider" y="400px"></div>
</foreignobject>
</svg>
<div id="ourLegend" max-width = "800"></div>
<br/>
<br/>
<div id="ourAverages" max-width = "800"></div>
<svg id="ageBarChart" width="400" height="250">
</svg>

<script>
  let svg = d3.select("svg#ageYelpPlot");
  let svg2 = d3.select("svg#ageBarChart");
  let width = svg.attr("width");
  let height = svg.attr("height");
  let width2 = svg2.attr("width");
  let height2 = svg2.attr("height");
  let margin = { top: 10, right: 10, bottom: 70, left: 60 };
  let chartWidth = width - margin.left - margin.right;
  // console.log(chartWidth);
  let chartHeight = height - margin.top - margin.bottom;
  let chartHeight2 = height2 - margin.top - margin.bottom;
  let chartWidth2 = width2 - margin.left - margin.right;


  //key is category we will show, value is Yelp categories that count for it
  let mapofRestaurantTypes = {
    'American': ['American (Traditional)', 'American (New)'],
    'Fast Food': ['Fast Food'],
    'Mexican': ['Mexican'],
    'Sandwiches': ['Sandwiches'],
    'Pizza': ['Pizza'],
    'Breakfast & Brunch': ['Breakfast & Brunch'],
    'Burgers': ['Burgers'],
    'Chinese': ['Chinese'],
    'Italian': ['Italian'],
    'Seafood': ['Seafood'],
    'Japanese': ['Japanese']
  }
  let arrayOfRestaurantTypes = Object.keys(mapofRestaurantTypes);


  const requestData = async () => {
    //Pulling in the two datasets
    const ageData = await d3.csv("pop_mod.csv");
    const yelpData = await d3.json("zip_code_averages.json");

    const isValidZip = (zip) => {
      if (yelpData[zip] == null) return false;
      const cats = yelpData[zip]['cats'];
      for (key in mapofRestaurantTypes) {
        const value = mapofRestaurantTypes[key];
        if (cats[value[0]] != null) {
          if (value.length > 1 && cats[value[1]] != null) {
            if (cats[value[0]].count + cats[value[1]].count > 15) { return true; }
          } else if (cats[value[0]].count > 15) return true;
        } else if (value.length > 1 && cats[value[1]] != null && cats[value[1]].count > 15) return true;
      }
      return false
    }

    //ageScale is used for x axis
    const ageMin = d3.min(ageData, d => isValidZip(d.zip) ? d.age :  100);
    const ageMax = d3.max(ageData, d => isValidZip(d.zip) ? d.age : 0);
    const ageScale = d3.scaleLinear()
            .domain([ageMin - 1, ageMax + 1])
            .range([0, chartWidth]);

    const barScale = d3.scaleBand()
            .domain(["left average", "right average"])
            .range([0,chartWidth2]);

    const ageInvScale = d3.scaleLinear()
            .domain([0, chartWidth])
            .range([ageMin - 1, ageMax + 1])

    //rating scale is used for y axis
    const ratingScale = d3.scaleLinear()
            .domain([0, 5])
            .range([chartHeight, 0]);

    const ratingScale2 = d3.scaleLinear()
            .domain([0, 5])
            .range([chartHeight2, 0]);

    const ratingInvScale = d3.scaleLinear()
            .domain([chartHeight, 0])
            .range([0,5])

    const colorScale = d3.scaleOrdinal()
      .domain(arrayOfRestaurantTypes)
      .range(['#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6','#6a3d9a','Brown']);

     // Y axis ticks
     let leftAxis = d3.axisLeft(ratingScale).ticks(5, d3.format(".1s"));
     svg.append("g").attr("class", "ticks")
       .attr("transform","translate("+ (margin.left-10) +","+ margin.top +")")
       .call(leftAxis);

     // X axis ticks
     let bottomAxis = d3.axisBottom(ageScale).ticks(8, d3.format("0s"));
     let element = svg.append("g").attr("class", "ticks")
       .attr("transform","translate("+ margin.left +","+ (margin.top + chartHeight + 10) +")");
     bottomAxis(element);

     // Y axis gridlines
     let leftGridlines = d3.axisLeft(ratingScale).tickSize(-chartWidth-10).tickFormat("");
     svg.append("g").attr("class", "gridlines")
       .attr("transform","translate("+ (margin.left-10) +","+ margin.top +")")
       .call(leftGridlines);

     // X axis gridlines
     let bottomGridlines = d3.axisBottom(ageScale).tickSize(-chartHeight-10).tickFormat("");
     element = svg.append("g").attr("class", "gridlines")
       .attr("transform","translate("+ margin.left +","+ (margin.top + chartHeight + 10) +")");
     bottomGridlines(element);
// <line x1="5" y1="5" x2="40" y2="40" stroke="gray" stroke-width="5"  />

    // Y axis ticks for bar graph
    let leftAxis2 = d3.axisLeft(ratingScale2).ticks(5, d3.format(".1s"));
     svg2.append("g").attr("class", "ticks")
       .attr("transform","translate("+ (margin.left-10) +","+ margin.top +")")
       .call(leftAxis2);

     // X axis ticks
    let bottomAxis2 = d3.axisBottom(barScale);
    let element2 = svg2.append("g").attr("class", "ticks")
       .attr("transform","translate("+ margin.left +","+ (margin.top + chartHeight2 + 10) +")");
    bottomAxis2(element2);

    svg.append("text")
      .attr("x", (width/2))
      .attr("y", chartHeight + margin.bottom+5)
      .text("Average resident age");

    svg.append("text")
      .attr("transform", "translate("+ (-235) +","+ ((height/2)+50) +") rotate(-90)")
      .attr("x", margin.left)
      .attr("y", (height/2))
      .text("Average Yelp rating");

    svg2.append("text")
      .attr("x", (width2/2))
      .attr("y", chartHeight2 + margin.bottom+5)
      .text("Averages");

    svg2.append("text")
      .attr("transform", "translate("+ (-235) +","+ ((height2/2)+50) +") rotate(-90)")
      .attr("x", margin.left)
      .attr("y", (height2/2))
      .text("Yelp rating");

    let scatter = svg.append("g")
           .attr("transform","translate("+margin.left+","+margin.top+")");

    let pointsData = [];

    ageData.forEach(function (d) {
      if (yelpData[d.zip] != null) {
        const cats = yelpData[d.zip]['cats'];
        Object.entries(mapofRestaurantTypes).forEach((mapping) => {
          const key = mapping[0];
          const value = mapping[1];
          let score;
          let count = 0;
          if (cats[value[0]] != null) {
            if (value.length > 1 && cats[value[1]] != null) {
              count = cats[value[0]].count + cats[value[1]].count;
              score = cats[value[0]].star_total + cats[value[1]].star_total;
            } else {
              count = cats[value[0]].count;
              score = cats[value[0]].star_total;
            }
          } else if (value.length > 1 && cats[value[1]] != null) {
            count = cats[value[1]].count;
            score = cats[value[1]].star_total;
          }
          if (score != undefined && count >= 5) {
            pointsData.push({
              age: d.age.toString(),
              rating: score / count,
              cat: key,
              zip: d.zip,
              city: yelpData[d.zip].city,
              state: yelpData[d.zip].state,
              key: key.split(' ')[0]
            })
          }
        })
      }
    });

    let points = scatter.selectAll('circle').data(pointsData)

    // console.log(pointsData);

    points.enter().append("circle")
        .attr("cx", d => ageScale(d.age))
        .attr("cy", d => ratingScale(d.rating))
        .attr("r", 4)
        .attr("opacity", 0.8)
        .style("fill", d => colorScale(d.cat))
        .attr("zip", d => d.zip)
        .attr("city", d => d.city + ", " + d.state)
        .attr("id", d => "C" + d.zip + d.key)
        .attr("restaurantType", d => d.key)
        // .attr("age", d => Math.round(d.age))
        .on("mouseover", d => {
          let attrbox = scatter.append("g").attr("class", "info-box")

          attrbox.append("rect")
            .attr("rx", 6)
            .attr("ry", 6)
            .attr("width", 170)
            .attr("height", 50)
            .attr("class", "info-box")
            .attr("stroke", "black")
            .attr("fill", "white")
            .attr("x", ageScale(d.age) + (d.age > Number(ageMin) + Number((ageMax - ageMin) / 2) ? -180 : 10))
            .attr("y", ratingScale(d.rating) + 10)

          attrbox.append("text").text(d.zip)
            .attr("x", ageScale(d.age) + 2 + (d.age > Number(ageMin) + Number((ageMax - ageMin) / 2) ? -180 : 10))
            .attr("y", ratingScale(d.rating) + 26)
          attrbox.append("text").text(d.cat)
            .attr("x", ageScale(d.age) + 2 + (d.age > Number(ageMin) + Number((ageMax - ageMin) / 2) ? -180 : 10))
            .attr("y", ratingScale(d.rating) + 41)
          attrbox.append("text").text(d.city + ", " + d.state)
            .attr("x", ageScale(d.age) + 2 + (d.age > Number(ageMin) + Number((ageMax - ageMin) / 2) ? -180 : 10))
            .attr("y", ratingScale(d.rating) + 56)
          scatter.selectAll("circle").each(function() {
            let circleWithSameZip = d3.select(this);
            if (circleWithSameZip.attr("id") === "C" + d.zip + d.key) {
              circleWithSameZip.attr("opacity", 0.8).attr("r", 6);
            }
            else {
              circleWithSameZip.attr("opacity", 0.1);
            }
          })
        })
        .on("mouseout", d => {
          d3.select(".info-box").remove();
          scatter.selectAll("circle").each(function() {
            let circle = d3.select(this);
            circle.attr("opacity", 0.8).attr("r", 4);
          })
        });

    let isCatDisplayeds = {}
    arrayOfRestaurantTypes.forEach((title) => {
      isCatDisplayeds[title] = true
    })

    const changeCats = (cats, isAdding) => {
      cats.forEach((cat) => {
        isCatDisplayeds[cat] = isAdding
      })

      scatter.selectAll('circle').data(pointsData).style("display", d => isCatDisplayeds[d.cat] ? "" : "none")
    }

    d3.select("#ourLegend")
        .append("button")
        .text("Show all")
        .attr("class", "allbutton")
        .on("click", (d, i, nodes) => {
          changeCats(arrayOfRestaurantTypes, true)
          d3.selectAll("#ourLegend button.deselected").attr("class", "selected")
        })
    d3.select("#ourLegend")
        .append("button")
        .text("Hide all")
        .attr("class", "allbutton")
        .on("click", (d, i, nodes) => {
          changeCats(arrayOfRestaurantTypes, false)
          d3.selectAll("#ourLegend button.selected").attr("class", "deselected")
        })

    //Legend for selecting data points based on category
    arrayOfRestaurantTypes.forEach(d => {
        let selectDiv = d3.select("#ourLegend")
          .append("div")
          .attr("id", d.split(' ')[0] + "-select-div")

        selectDiv.append("button").text(d)
          .style("border-color", colorScale(d))
          .style("color", colorScale(d))
          .attr("class", "selected")
          /*.on("mouseover", function() {
            let totalRatingLeft = 0;
            let numLeft = 0;
            let totalRatingRight = 0;
            let numRight = 0;
            scatter.selectAll("circle").each(function() {
              let circle = d3.select(this);
              if (circle.attr("restaurantType") === d.split(' ')[0]) {
                circle.attr("opacity", 0.8);
                if (ageInvScale(circle.attr("cx")) < ageCompValue) {
                  totalRatingLeft = totalRatingLeft + ratingInvScale(circle.attr("cy"));
                  numLeft = numLeft + 1;
                } else {
                  totalRatingRight = totalRatingRight + ratingInvScale(circle.attr("cy"));
                  numRight = numRight + 1;
                }
              }
              else {
                circle.attr("opacity", 0.1);
              }
            })

            //I don't want NaN to be displayed, so rather than dividing by 0, I divide by 1
            if (numLeft == 0) {
              numLeft = 1;
            }
            if (numRight == 0) {
              numRight = 1;
            }
            d3.select("#ourAverages").html("")
              .append("p").text(d)
              .style("font-size", "25px")
              .style("padding", "30px")
              .style("margin-left", "50px")
              .style("margin-bottom", "30px")
              .style("color", colorScale(d))
              .append("p").text("Average Rating for Average Age younger than " + ageCompValue + ": " + Math.round(100*(totalRatingLeft/numLeft))/100)
              .append("p").text("Average Rating for Average Age older than " + ageCompValue + ": " + Math.round(100*(totalRatingRight/numRight))/100);
          })
          .on("mouseout", function() {
            scatter.selectAll("circle").each(function() {
              let circle = d3.select(this);
              circle.attr("opacity", 0.8);
            })
            d3.select("#ourAverages").html("");
          })*/
          .on("click", function() {
            d3.select(this).attr("class", isCatDisplayeds[d] ? "deselected" : "selected")
            changeCats([d], !isCatDisplayeds[d])
          })
        });

    // console.log(isCatDisplayeds);

    let ageCompValue = 40;

    // let ageCompValue = Math.round((ageMin + ageMax)/2);
    // let ageCompValue = 40;
    var slidersDiv = d3.select("#divForSlider").append("div");
    slidersDiv.append("div").text("Age to Compare Against")
        .append("div").append("input")
        .attr("type", "range")
        .style("width","750px")
        .attr("min", Math.round(ageMin))
        .attr("max", Math.round(ageMax))
        .attr("step", 1)
        .attr("value",ageCompValue)
        .on("input", function () {
          ageCompValue = Number(this.value);
          console.log(ageCompValue);
          console.log(ageMax);
          console.log(ageMin);
          // svg.remove("line");
          d3.select("#myLine")
           .attr("x1", ageScale(ageCompValue) + margin.left + "px")
           .attr("y1", "10px")
           .attr("x2", ageScale(ageCompValue) + + margin.left + "px")
           .attr("y2", "455px")
           .style("stroke", "#d32323")
           .style("stroke-width", "3px");
          //Call showCircles with the hue value selected on the slider
          // showCircles(Number(this.value));
          updateBarChart(ageCompValue);
        });

    function updateBarChart(ageCompValue) {
      d3.selectAll('.bar').remove();
      validRes = [];
      arrayOfRestaurantTypes.forEach(d => {
        if (isCatDisplayeds[d])
          validRes.push(d);
      });
      let totalRatingLeft = 0;
      let numLeft = 0;
      let totalRatingRight = 0;
      let numRight = 0;
      scatter.selectAll("circle").each(function() {
        let circle = d3.select(this);
        if (validRes.includes(circle.attr("restaurantType"))) {
          if (ageInvScale(circle.attr("cx")) < ageCompValue) {
            totalRatingLeft = totalRatingLeft + ratingInvScale(circle.attr("cy"));
            numLeft = numLeft + 1;
          } else {
            totalRatingRight = totalRatingRight + ratingInvScale(circle.attr("cy"));
            numRight = numRight + 1;
          }
        }
      });

      //I don't want NaN to be displayed, so rather than dividing by 0, I divide by 1
      if (numLeft == 0) {
        numLeft = 1;
      }
      if (numRight == 0) {
        numRight = 1;
      }

      // console.log(totalRatingLeft);
      // console.log(numLeft);
      // console.log(totalRatingRight);
      // console.log(numRight);

      svg2.append("line").attr("class", "bar")
        .attr("x1", barScale('left average')+145)
        .attr("x2", barScale('left average')+145)
        .attr("y1", height2-60)
        .attr("y2", (height2-60) - ratingScale(Math.round(100*(totalRatingLeft/numLeft))/100))
        .style("stroke-width", 70)
        .style("stroke", "#d32323");

      svg2.append("text").attr("class", "bar")
        .attr("text-anchor", "middle")
        .attr("font-size", "20px")
        .attr("x", barScale('left average')+145)
        .attr("y", ((height2-60) - ratingScale(Math.round(100*(totalRatingLeft/numLeft))/100))-10)
        .text((totalRatingLeft/numLeft).toFixed(2));

      svg2.append("line").attr("class", "bar")
        .attr("x1", barScale('right average')+145)
        .attr("x2", barScale('right average')+145)
        .attr("y1", height2-60)
        .attr("y2", (height2-60) - ratingScale(Math.round(100*(totalRatingRight/numRight))/100))
        .style("stroke-width", 70)
        .style("stroke", "#fcd6d3");

      svg2.append("text").attr("class", "bar")
        .attr("text-anchor", "middle")
        .attr("font-size", "20px")
        .attr("x", barScale('right average')+145)
        .attr("y", ((height2-60) - ratingScale(Math.round(100*(totalRatingRight/numRight))/100))-10)
        .text((totalRatingRight/numRight).toFixed(2));
    }

    updateBarChart(ageCompValue);
  }
  requestData();

</script>
</body>
</html>
